trigger: none

parameters:
  - name: featureTitle
    type: string
    displayName: 'Feature Title'
    default: ''
  - name: parentInput
    type: string
    displayName: 'Parent Work Item URL or ID'
    default: ''

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    set -euo pipefail

    ORG="sovereignhousingassociationvsts"
    PROJECT="Enterprise Data Warehouse"
    PROJECT_URL_ENCODED="Enterprise%20Data%20Warehouse"

    FEATURE_TITLE="${{ parameters.featureTitle }}"
    if [[ -z "$FEATURE_TITLE" ]]; then
      echo "‚ùå Feature Title must be provided."
      exit 1
    fi

    PARENT_INPUT="${{ parameters.parentInput }}"

    function extract_id() {
      local input="$1"
      if [[ "$input" =~ ^[0-9]+$ ]]; then
        echo "$input"
      else
        local id=$(echo "$input" | grep -oE '[0-9]+' | tail -1)
        echo "$id"
      fi
    }

    if [[ -z "$PARENT_INPUT" ]]; then
      echo "No parent work item specified. Defaulting to Epic ID 108342 and fixed Area Path."
      EPIC_ID="108342"
      AREA_PATH="Enterprise Data Warehouse\\Data and Analytics"
    else
      EPIC_ID=$(extract_id "$PARENT_INPUT")
      if [[ -z "$EPIC_ID" ]]; then
        echo "‚ùå Could not extract work item ID from input: $PARENT_INPUT"
        exit 1
      fi

      WORK_ITEM_URL="https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/$EPIC_ID?api-version=7.0"
      RESPONSE=$(curl -sS -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN" "$WORK_ITEM_URL")
      AREA_PATH=$(echo "$RESPONSE" | jq -r '.fields["System.AreaPath"] // empty')

      if [[ -z "$AREA_PATH" || "$AREA_PATH" == "null" ]]; then
        echo "‚ùå Could not retrieve Area Path for work item ID $EPIC_ID"
        exit 1
      fi
    fi

    FEATURE_DESC="<b>Background</b><br>Provide a problem statement / summary of business issue...<br>"

    # Create Feature
    FEATURE_JSON=$(jq -n \
      --arg title "$FEATURE_TITLE" \
      --arg area "$AREA_PATH" \
      --arg epic_url "https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/$EPIC_ID" \
      --arg desc "$FEATURE_DESC" \
      '[
        {"op":"add","path":"/fields/System.Title","value":$title},
        {"op":"add","path":"/fields/System.Description","value":$desc},
        {"op":"add","path":"/fields/System.AreaPath","value":$area},
        {"op":"add","path":"/relations/-","value":{
          "rel":"System.LinkTypes.Hierarchy-Reverse",
          "url": $epic_url
        }}
      ]')

    FEATURE_RESPONSE=$(curl -sS -X POST \
      -H "Content-Type: application/json-patch+json" \
      -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN" \
      -d "$FEATURE_JSON" \
      "https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/\$Feature?api-version=7.0")

    FEATURE_ID=$(echo "$FEATURE_RESPONSE" | jq -r '.id // empty')

    if [[ -z "$FEATURE_ID" || "$FEATURE_ID" == "null" ]]; then
      echo "‚ùå Failed to create Feature."
      echo "$FEATURE_RESPONSE"
      exit 1
    fi

    echo "‚úÖ Created Feature $FEATURE_ID"

    # User Stories array
    USER_STORIES=(
      "01 - Data Acquisition|As a data engineer, I want to ingest source system data into the data lake."
      "02 - Data Validation|As a data engineer, I want to validate data quality upon ingestion."
      "03 - Data Transformation|As a developer, I want to transform ingested data into canonical formats."
      "04 - Data Storage|As a data engineer, I want to store transformed data in the warehouse."
      "05 - Data Modeling|As a data modeler, I want to design data models to support reporting."
      "06 - Reporting Layer|As a BI developer, I want to create semantic layer views for consumption."
      "07 - Security & Access|As a security officer, I want to define access controls on data assets."
      "08 - Monitoring & Alerting|As an operator, I want to monitor data pipelines and receive alerts."
      "09 - Documentation|As a team member, I want to document pipeline processes and data models."
      "10 - Handover & Training|As a project manager, I want to train end-users and handover support."
    )

    STORY_IDS=()

    i=0
    for STORY in "${USER_STORIES[@]}"; do
      ((i++))
      TITLE=$(echo "$STORY" | cut -d'|' -f1)
      DESC=$(echo "$STORY" | cut -d'|' -f2-)

      STACKRANK=$((1000 + i * 100))
      STORY_JSON=$(jq -n \
        --arg title "$TITLE" \
        --arg desc "$DESC" \
        --arg area "$AREA_PATH" \
        --argjson stackrank "$STACKRANK" \
        '[
          {"op":"add","path":"/fields/System.Title","value":$title},
          {"op":"add","path":"/fields/System.Description","value":$desc},
          {"op":"add","path":"/fields/System.AreaPath","value":$area},
          {"op":"add","path":"/fields/Microsoft.VSTS.Common.StackRank","value":$stackrank}
        ]')

      STORY_RESPONSE=$(curl -sS -X POST \
        -H "Content-Type: application/json-patch+json" \
        -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN" \
        -d "$STORY_JSON" \
        "https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/\$User%20Story?api-version=7.0")

      STORY_ID=$(echo "$STORY_RESPONSE" | jq -r '.id // empty')
      if [[ -z "$STORY_ID" || "$STORY_ID" == "null" ]]; then
        echo "‚ùå Failed to create User Story: $TITLE"
        echo "$STORY_RESPONSE"
        exit 1
      fi

      STORY_IDS+=("$STORY_ID")
      echo "   - Created Story $TITLE (ID $STORY_ID)"
    done

    # Link User Stories to Feature
    FEATURE_API_URL="https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/$FEATURE_ID"
    for STORY_ID in "${STORY_IDS[@]}"; do
      LINK_JSON=$(jq -n \
        --arg feature_url "$FEATURE_API_URL" \
        '[
          {"op":"add","path":"/relations/-","value":{"rel":"System.LinkTypes.Hierarchy-Forward","url":$feature_url}}
        ]')

      LINK_RESPONSE=$(curl -sS -X PATCH \
        -H "Content-Type: application/json-patch+json" \
        -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN" \
        -d "$LINK_JSON" \
        "https://dev.azure.com/$ORG/$PROJECT_URL_ENCODED/_apis/wit/workitems/$STORY_ID?api-version=7.0")

      LINK_ID=$(echo "$LINK_RESPONSE" | jq -r '.id // empty')
      if [[ -z "$LINK_ID" ]]; then
        echo "‚ùå Failed to link Story ID $STORY_ID to Feature $FEATURE_ID"
        echo "$LINK_RESPONSE"
        exit 1
      fi
      echo "   - Linked Story ID $STORY_ID to Feature $FEATURE_ID"
    done

    echo "üéâ Feature $FEATURE_ID and ${#STORY_IDS[@]} User Stories created and linked successfully."
  displayName: 'Create Feature and Ordered User Stories'
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
